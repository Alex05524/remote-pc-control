<!doctype html>
<meta charset="utf-8"/>
<title>Remote PC Control ‚Äî –ü–∞–Ω–µ–ª—å</title>
<link rel="stylesheet" href="/static/styles.css">

<header class="topbar">
  <div class="brand">
    <div class="logo">üñ•Ô∏è</div>
    <div class="title">
      <h1>Remote PC Control</h1>
      <div class="subtitle">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞–º–∏</div>
    </div>
  </div>
  <div class="stats">
    <div class="stat">
      <span class="label">–û–Ω–ª–∞–π–Ω</span>
      <span class="value" id="count-online">0</span>
    </div>
    <div class="stat">
      <span class="label">–í—Å–µ–≥–æ</span>
      <span class="value" id="count-total">0</span>
    </div>
  </div>
</header>

<main class="container">
  <section class="toolbar card">
    <div class="left">
      <form class="inline" onsubmit="return createGroup()">
        <input id="gname" class="input" placeholder="–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞" required>
        <button class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
      </form>
      <div class="divider"></div>
      <input id="search" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –ü–ö‚Ä¶" oninput="setSearch(this.value)">
      <label class="check">
        <input type="checkbox" id="show-offline" onchange="toggleShowOffline(this.checked)">
        <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—Ñ—Ñ–ª–∞–π–Ω</span>
      </label>
      <span id="refresh-indicator" class="muted" style="font-size:12px;"></span>
    </div>
    <div class="right">
      <a class="btn" href="/offline">–û—Ñ—Ñ–ª–∞–π–Ω –∫–æ–º–ø—å—é—Ç–µ—Ä—ã</a>
      <button class="btn" onclick="manualRefresh()">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </section>

  <section class="grid">
    <aside class="card sidebar">
      <div class="card-title">–ì—Ä—É–ø–ø—ã</div>
      <ul id="groups" class="group-list"></ul>
    </aside>

    <section class="card content">
      <div class="card-title">–ö–æ–º–ø—å—é—Ç–µ—Ä—ã</div>
      <table class="table table-agents" id="agents">
        <colgroup>
          <col class="c-status">
          <col class="c-host">
          <col class="c-group">
          <col class="c-actions">
        </colgroup>
        <thead>
          <tr>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ò–º—è –ü–ö</th>
            <th>–ì—Ä—É–ø–ø–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <aside class="card info-panel">
      <div class="card-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
      <div id="info" class="info info-view">
        <div class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</div>
      </div>
      <div class="assign">
        <label class="assign-label" for="assign-group">–ù–∞–∑–Ω–∞—á–∏—Ç—å –≥—Ä—É–ø–ø—É</label>
        <div class="assign-row">
          <select id="assign-group" class="input input-select"></select>
          <button id="assign-apply" class="btn btn-primary btn-sm" onclick="assignGroup()">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
          <button id="assign-clear" class="btn btn-sm" onclick="clearGroup()">–£–¥–∞–ª–∏—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã</button>
        </div>
        <div id="assign-status" class="muted assign-status" style="min-height:16px;font-size:12px;"></div>
      </div>
    </aside>
  </section>
</main>

<footer class="footer">
  <div>¬© Remote PC Control ‚Ä¢ –õ–æ–∫–∞–ª—å–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è</div>
</footer>

<script>
/* === –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è === */
const REFRESH_INTERVAL = 8000;
const PAUSE_ON_INTERACT = 20000;

let refreshTimer = null;
let pauseTimer = null;
let lastRefreshOk = true;

const INFO_PLACEHOLDER = '<div class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</div>';

const state = {
  groups: [],
  agents: [],
  selectedGroupId: null,
  search: "",
  showOffline: false,
  selectedAgentId: null,
  infoAgentId: null,
  isPaused: false,
  groupEditDirty: false        /* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏–ª select, –Ω–æ –µ—â—ë –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª */
};

function g(id){ return document.getElementById(id); }
function esc(s){ return (s??"").toString().replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c])); }
function N(v){ return v==null?"":String(v); }
async function j(u,o){ const r=await fetch(u,o); if(!r.ok) throw new Error(r.status); return r.json(); }

/* === –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä === */
function setRefreshIndicator(text){
  const el = g("refresh-indicator");
  if(!el) return;
  el.textContent = text||"";
}

/* === –ü–∞—É–∑–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è === */
function pauseAutoRefresh(ms = PAUSE_ON_INTERACT){
  state.isPaused = true;
  setRefreshIndicator("‚è∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ");
  if(pauseTimer) clearTimeout(pauseTimer);
  pauseTimer = setTimeout(()=>{
    state.isPaused = false;
    setRefreshIndicator("");
  }, ms);
}

function startPolling(){
  stopPolling();
  async function tick(){
    if(!state.isPaused){
      try {
        await loadAgents();
        lastRefreshOk = true;
      } catch(e){
        lastRefreshOk = false;
        console.warn("refresh error", e);
        setRefreshIndicator("‚ö† –æ—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
      }
    }
    refreshTimer = setTimeout(tick, REFRESH_INTERVAL);
  }
  refreshTimer = setTimeout(tick, REFRESH_INTERVAL);
}
function stopPolling(){
  if(refreshTimer) clearTimeout(refreshTimer);
  refreshTimer = null;
}
function manualRefresh(){
  pauseAutoRefresh(5000);
  loadAgents();
}

/* === –§–∏–ª—å—Ç—Ä—ã === */
function setSearch(v){
  state.search = (v||"").toLowerCase();
  renderAgents();
  pauseAutoRefresh();
}
function toggleShowOffline(v){
  state.showOffline = !!v;
  renderAgents();
  pauseAutoRefresh();
}

/* === –°—á—ë—Ç—á–∏–∫–∏ === */
function renderCounts(){
  g("count-total").textContent = state.agents.length;
  g("count-online").textContent = state.agents.filter(a=>a.online).length;
}

/* === –ì—Ä—É–ø–ø—ã === */
function renderGroups(){
  const ul = g("groups");
  ul.innerHTML = "";
  const liAll = document.createElement("li");
  liAll.className = "group-item" + (state.selectedGroupId===null?" active":"");
  liAll.textContent = "–í—Å–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã";
  liAll.onclick = ()=>{
    state.selectedGroupId=null;
    renderGroups(); renderAgents(); pauseAutoRefresh();
  };
  ul.appendChild(liAll);

  for(const grp of state.groups){
    const li = document.createElement("li");
    li.className = "group-item" + (state.selectedGroupId===grp.id?" active":"");
    li.textContent = grp.name;
    li.title = `ID: ${grp.id}`;
    li.onclick = ()=>{
      state.selectedGroupId = grp.id;
      renderGroups(); renderAgents(); pauseAutoRefresh();
    };
    ul.appendChild(li);
  }

  const sel = g("assign-group");
  if(sel){
    const prevVal = sel.value;
    sel.innerHTML = '<option value="">(–Ω–µ—Ç)</option>' +
      state.groups.map(x=>`<option value="${x.id}">${esc(x.name)}</option>`).join("");
    if(!state.groupEditDirty) sel.value = prevVal; // –Ω–µ –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞–µ–º, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç
  }
  updateAssignControls();
}

/* === –°—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã === */
function agentRow(a){
  const selected = state.selectedAgentId===a.agent_id ? " selected":"";
  const infoActive = state.infoAgentId===a.agent_id ? " btn-active":"";
  const dot = a.online ? '<span class="dot on" title="–û–Ω–ª–∞–π–Ω"></span>' :
                         '<span class="dot off" title="–û—Ñ—Ñ–ª–∞–π–Ω"></span>';
  const name = esc(a.hostname)||a.agent_id;
  const group = esc(a.group_name)||"-";
  const viewBtn = a.online
    ? `<a class="btn btn-primary btn-sm" href="/view/${a.agent_id}" onclick="event.stopPropagation()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</a>`
    : `<button class="btn btn-sm" disabled>–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>`;
  const unBtn = a.group_id!=null
    ? `<button class="btn btn-sm" onclick="event.stopPropagation(); unassignAgent('${a.agent_id}')">–£–±—Ä–∞—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã</button>`
    : "";
  return `<tr onclick="selectAgent('${a.agent_id}')" class="row-link${selected}">
    <td class="status">${dot}</td>
    <td class="host">
      <div class="host-name">${name}</div>
      <div class="muted">${a.agent_id}</div>
    </td>
    <td class="group">${group}</td>
    <td class="actions">
      ${viewBtn}
      <button class="btn btn-sm${infoActive}" onclick="event.stopPropagation(); toggleInfo('${a.agent_id}')">–ò–Ω—Ñ–æ</button>
      ${unBtn}
    </td>
  </tr>`;
}

/* === –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –æ—Ñ—Ñ–ª–∞–π–Ω === */
function dedupeByHostnamePreferOnline(list){
  const map=new Map();
  for(const a of list){
    const k=(a.hostname||"").toLowerCase();
    const st=map.get(k)||{hasOnline:false};
    if(a.online) st.hasOnline=true;
    map.set(k,st);
  }
  return list.filter(a=>{
    const k=(a.hostname||"").toLowerCase();
    const hasOnline=map.get(k)?.hasOnline;
    return !(hasOnline && !a.online);
  });
}

/* === –†–µ–Ω–¥–µ—Ä –∞–≥–µ–Ω—Ç–æ–≤ === */
function renderAgents(){
  if(state.selectedAgentId && !state.agents.some(a=>a.agent_id===state.selectedAgentId))
    state.selectedAgentId=null;
  if(state.infoAgentId && !state.agents.some(a=>a.agent_id===state.infoAgentId))
    state.infoAgentId=null;

  let list=[...state.agents];
  if(state.selectedGroupId!==null) list=list.filter(a=>a.group_id===state.selectedGroupId);
  if(!state.showOffline) list=list.filter(a=>a.online);
  if(state.search){
    const q=state.search;
    list=list.filter(a=>
      (a.hostname||"").toLowerCase().includes(q) ||
      (a.agent_id||"").toLowerCase().includes(q) ||
      (a.group_name||"").toLowerCase().includes(q)
    );
  }
  if(state.showOffline) list=dedupeByHostnamePreferOnline(list);
  list.sort((a,b)=>(b.online-a.online)|| (a.hostname||"").localeCompare(b.hostname||""));

  g("agents").querySelector("tbody").innerHTML = list.map(agentRow).join("");
  renderCounts();
  updateAssignControls();
  updateInfoPanel();
}

/* === –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è === */
function pills(arr){
  arr=Array.isArray(arr)?arr:[];
  if(!arr.length) return '<span class="muted">‚Äî</span>';
  return `<div class="pills">${arr.map(x=>`<span class="pill">${esc(x)}</span>`).join("")}</div>`;
}
function kv(rows){
  return `<dl class="kv">${rows.map(([k,v])=>`<dt>${esc(k)}</dt><dd>${v||'<span class="muted">‚Äî</span>'}</dd>`).join("")}</dl>`;
}
function section(t,b){ return `<div class="section"><h4>${esc(t)}</h4>${b}</div>`; }

function buildInfoHTML(a){
  const info = a?.info || {};
  const screen = info.screen || {};
  const hw = info.hardware || {};
  const cpuInfo = hw.cpu || {};          // –±—ã–ª–æ cpu
  const sys = hw.system_model || {};
  const ip = N(info.ip), mac = N(info.mac);
  const badge = a.online ? '<span class="chip chip-on">–û–Ω–ª–∞–π–Ω</span>' : '<span class="chip">–û—Ñ—Ñ–ª–∞–π–Ω</span>';

  const header = `<div class="agent-header">
    <div class="agent-title">
      <div class="agent-name">${esc(a.hostname||a.agent_id)}</div>
      <div class="agent-sub muted">${esc(a.agent_id)}</div>
    </div>
    <div class="agent-badges">
      ${badge}${info.admin?'<span class="chip chip-admin">Admin</span>':""}
    </div>
  </div>`;

  const general = kv([
    ["–ò–º—è –ü–ö", esc(a.hostname||"")],
    ["–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", esc(info.user||"")],
    ["–û–°", esc(info.os||"")],
    ["FQDN", esc(info.fqdn||"")],
    ["–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", esc(a.last_seen||"")]
  ]);

  const network = kv([
    ["–û—Å–Ω–æ–≤–Ω–æ–π IP", ip?`<span class="mono">${esc(ip)}</span>`:""],
    ["–í—Å–µ IP", pills(info.ips||[])],
    ["–û—Å–Ω–æ–≤–Ω–æ–π MAC", mac?`<span class="mono">${esc(mac)}</span>`:""],
    ["–í—Å–µ MAC", pills(info.macs||[])]
  ]);

  const screenSec = kv([
    ["–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ",(screen.width&&screen.height)?`<span class="mono">${screen.width} √ó ${screen.height}</span>`:""]
  ]);

  const cpuLine = [
    esc(cpuInfo.model||""),
    (cpuInfo.cores_physical||cpuInfo.cores_logical)?`, —è–¥—Ä–∞: ${cpuInfo.cores_physical||"-"} / ${cpuInfo.cores_logical||"-"}`:"",
    cpuInfo.freq_mhz?`, ${cpuInfo.freq_mhz} –ú–ì—Ü`:""
  ].join("");

  const hardware = kv([
    ["CPU", cpuLine||""],
    ["RAM", hw.ram_gb?`<span class="mono">${hw.ram_gb} –ì–ë</span>`:""],
    ["–°–∏—Å—Ç–µ–º–∞",(sys.manufacturer||sys.product_name)?esc(`${sys.manufacturer||""} ${sys.product_name||""}`.trim()):""]
  ]);

  return header + section("–û–±—â–µ–µ", general) + section("–°–µ—Ç—å", network) +
         section("–≠–∫—Ä–∞–Ω", screenSec) + section("–ñ–µ–ª–µ–∑–æ", hardware);
}
function updateInfoPanel(){
  const box=g("info");
  if(!box) return;
  if(!state.infoAgentId){ box.innerHTML=INFO_PLACEHOLDER; return; }
  const agent=state.agents.find(a=>a.agent_id===state.infoAgentId);
  if(!agent){ state.infoAgentId=null; box.innerHTML=INFO_PLACEHOLDER; return; }
  box.innerHTML=buildInfoHTML(agent);
}

/* === –í—ã–±–æ—Ä === */
function selectAgent(id){
  state.selectedAgentId = state.selectedAgentId===id?null:id;
  if(state.selectedAgentId) pauseAutoRefresh();
  state.groupEditDirty=false;   // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≤—ã–±–æ—Ä
  renderAgents();
}
function toggleInfo(id){
  state.infoAgentId = state.infoAgentId===id?null:id;
  if(state.infoAgentId) pauseAutoRefresh();
  renderAgents();
}

/* === –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã === */
function updateAssignControls(){
  const select=g("assign-group");
  const apply =g("assign-apply");
  const clear =g("assign-clear");
  const agent =state.selectedAgentId?state.agents.find(a=>a.agent_id===state.selectedAgentId):null;

  if(select){
    if(!agent){
      if(!state.groupEditDirty) select.value="";
      select.disabled=true;
    } else {
      select.disabled=false;
      if(!state.groupEditDirty){
        if(agent.group_id!=null) select.value=String(agent.group_id);
        else select.value="";
      }
    }
  }
  if(apply){
    const selVal = select?select.value:"";
    const same = !agent || (agent.group_id==null && selVal==="") ||
                 (agent && agent.group_id!=null && selVal===String(agent.group_id));
    apply.disabled = !agent || same;
  }
  if(clear){
    clear.disabled = !agent || !agent.group_id;
  }
}

async function assignGroup(){
  const id=state.selectedAgentId;
  if(!id) return;
  const select=g("assign-group");
  const apply =g("assign-apply");
  const clear =g("assign-clear");
  const status=g("assign-status");
  const val=select.value;
  const gid=val?Number(val):null;
  const agent=state.agents.find(a=>a.agent_id===id);

  if(agent && ((agent.group_id==null && gid==null) || agent.group_id===gid)){
    status.textContent="–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π";
    setTimeout(()=>{ if(status.textContent==="–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π") status.textContent=""; },1600);
    return;
  }

  pauseAutoRefresh(12000);
  select.disabled=true; apply.disabled=true; clear.disabled=true;
  status.textContent="–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";

  try{
    await j(`/api/agents/${encodeURIComponent(id)}/assign_group`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ group_id: gid })
    });
    if(agent){
      agent.group_id = gid;
      agent.group_name = gid==null? null : (state.groups.find(g=>g.id===gid)?.name || null);
    }
    state.groupEditDirty=false;
    renderAgents();
    status.textContent="–ì—Ä—É–ø–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞";
  }catch(e){
    console.error(e);
    status.textContent="–û—à–∏–±–∫–∞";
  }finally{
    setTimeout(()=>{ status.textContent=""; },2200);
    select.disabled=false;
    updateAssignControls();
  }
}

async function clearGroup(){
  if(!state.selectedAgentId) return;
  const select=g("assign-group");
  select.value="";
  state.groupEditDirty=true;
  await assignGroup();
}

async function unassignAgent(id){
  pauseAutoRefresh();
  await j(`/api/agents/${encodeURIComponent(id)}/assign_group`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ group_id: null })
  });
  await loadAgents();
  if(state.selectedAgentId===id){
    const agent=state.agents.find(a=>a.agent_id===id);
    if(agent) agent.group_id=null;
    state.groupEditDirty=false;
    updateAssignControls();
  }
}

/* === CRUD –≥—Ä—É–ø–ø === */
async function createGroup(){
  const name=g("gname").value.trim();
  if(!name) return false;
  await j("/api/groups",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ name })
  });
  g("gname").value="";
  await loadGroups();
  return false;
}

/* === –ó–∞–≥—Ä—É–∑–∫–∞ === */
async function loadGroups(){
  const data=await j("/api/groups");
  state.groups=data.groups||[];
  renderGroups();
}
async function loadAgents(){
  const data=await j("/api/agents");
  state.agents=data.agents||[];
  renderAgents();
}
async function loadAll(){
  await Promise.all([loadGroups(), loadAgents()]);
}

/* === Init === */
document.addEventListener("DOMContentLoaded", ()=>{
  g("show-offline").checked=state.showOffline;
  const sel=g("assign-group");
  if(sel){
    sel.addEventListener("focus", ()=>{
      state.groupEditDirty=false;
      pauseAutoRefresh();
    });
    sel.addEventListener("change", ()=>{
      state.groupEditDirty=true;         // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
      pauseAutoRefresh();
      updateAssignControls();
    });
    sel.addEventListener("blur", ()=>{
      // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—à—ë–ª –∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª ‚Äî —á–µ—Ä–µ–∑ –ø–∞—É–∑—É –æ—Ç–∫–∞—Ç–∏–º
      setTimeout(()=>{
        if(state.groupEditDirty){
          // –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º, –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –≤—ã–±–æ—Ä (–Ω–µ –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞–µ–º)
        }
      },300);
    });
  }
  loadAll().then(startPolling);
});

/* –£–¥–∞–ª—è–µ–º –ø—Ä–µ–∂–Ω–∏–π setInterval ‚Äî –Ω–µ –Ω—É–∂–µ–Ω */
</script>