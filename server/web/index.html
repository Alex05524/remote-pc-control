<!doctype html>
<meta charset="utf-8"/>
<title>Remote PC Control ‚Äî –ü–∞–Ω–µ–ª—å</title>
<link rel="stylesheet" href="/static/styles.css">

<header class="topbar">
  <div class="brand">
    <div class="logo">üñ•Ô∏è</div>
    <div class="title">
      <h1>Remote PC Control</h1>
      <div class="subtitle">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞–º–∏</div>
    </div>
  </div>
  <div class="stats">
    <div class="stat">
      <span class="label">–û–Ω–ª–∞–π–Ω</span>
      <span class="value" id="count-online">0</span>
    </div>
    <div class="stat">
      <span class="label">–í—Å–µ–≥–æ</span>
      <span class="value" id="count-total">0</span>
    </div>
  </div>
</header>

<main class="container">
  <section class="toolbar card">
    <div class="left">
      <form class="inline" onsubmit="return createGroup()">
        <input id="gname" class="input" placeholder="–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞" required>
        <button class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
      </form>
      <div class="divider"></div>
      <input id="search" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –ü–ö‚Ä¶" oninput="setSearch(this.value)">
      <label class="check">
        <input type="checkbox" id="only-online" onchange="toggleOnlyOnline(this.checked)">
        <span>–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω</span>
      </label>
    </div>
    <div class="right">
      <button class="btn" onclick="loadAll()">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </section>

  <section class="grid">
    <aside class="card sidebar">
      <div class="card-title">–ì—Ä—É–ø–ø—ã</div>
      <ul id="groups" class="group-list"></ul>
    </aside>

    <section class="card content">
      <div class="card-title">–ö–æ–º–ø—å—é—Ç–µ—Ä—ã</div>
      <table class="table" id="agents">
        <thead>
          <tr>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ò–º—è –ü–ö</th>
            <th>–ì—Ä—É–ø–ø–∞</th>
            <th class="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <aside class="card info-panel">
      <div class="card-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
      <!-- –±—ã–ª–æ: <pre id="info" class="info"></pre> -->
      <div id="info" class="info info-view">
        <div class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</div>
      </div>
      <div class="assign">
        <label for="assign-group">–ù–∞–∑–Ω–∞—á–∏—Ç—å –≥—Ä—É–ø–ø—É:</label>
        <select id="assign-group" class="input small"></select>
        <button class="btn btn-primary small" onclick="assignGroup()">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
        <button class="btn small" onclick="clearGroup()">–£–¥–∞–ª–∏—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã</button>
      </div>
    </aside>
  </section>
</main>

<footer class="footer">
  <div>¬© Remote PC Control ‚Ä¢ –õ–æ–∫–∞–ª—å–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è</div>
</footer>

<script>
const state = {
  groups: [],
  agents: [],
  selectedGroupId: null,
  search: "",
  onlyOnline: false,
  currentAgentId: null,
};

async function j(u,o){const r=await fetch(u,o); if(!r.ok) throw new Error(r.status); return r.json();}
function esc(s){return (s??"").toString().replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c]))}
function g(id){return document.getElementById(id)}
function N(v){return v===undefined||v===null?"":String(v)}

function setSearch(v){ state.search = (v||"").toLowerCase(); renderAgents(); }
function toggleOnlyOnline(v){ state.onlyOnline = !!v; renderAgents(); }

function renderCounts(){
  const total = state.agents.length;
  const online = state.agents.filter(a=>a.online).length;
  g("count-total").textContent = total;
  g("count-online").textContent = online;
}

function renderGroups(){
  const ul = g("groups"); ul.innerHTML = "";
  const liAll = document.createElement("li");
  liAll.className = "group-item" + (state.selectedGroupId===null ? " active" : "");
  liAll.textContent = "–í—Å–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã";
  liAll.onclick = ()=>{ state.selectedGroupId = null; renderGroups(); renderAgents(); };
  ul.appendChild(liAll);
  for (const grp of state.groups){
    const li = document.createElement("li");
    li.className = "group-item" + (state.selectedGroupId===grp.id ? " active" : "");
    li.textContent = grp.name;
    li.title = `ID: ${grp.id}`;
    li.onclick = ()=>{ state.selectedGroupId = grp.id; renderGroups(); renderAgents(); };
    ul.appendChild(li);
  }
  const sel = g("assign-group");
  sel.innerHTML = '<option value="">(–Ω–µ—Ç)</option>' + state.groups.map(x=>`<option value="${x.id}">${esc(x.name)}</option>`).join("");
}

function agentRow(a){
  const dot = a.online ? '<span class="dot on" title="–û–Ω–ª–∞–π–Ω"></span>' : '<span class="dot off" title="–û—Ñ—Ñ–ª–∞–π–Ω"></span>';
  const name = esc(a.hostname)||a.agent_id;
  const group = esc(a.group_name)||"-";
  const viewBtn = a.online ? `<a class="btn btn-primary btn-sm" href="/view/${a.agent_id}">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</a>` : `<button class="btn btn-sm" disabled>–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>`;
  const unassignBtn = (a.group_id!=null)
     ? `<button class="btn btn-sm" onclick="event.stopPropagation(); unassignAgent('${a.agent_id}')">–£–±—Ä–∞—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã</button>`
     : "";
  return `<tr onclick="info('${a.agent_id}')" class="row-link">
    <td class="status">${dot}</td>
    <td class="host"><div class="host-name">${name}</div><div class="muted">${a.agent_id}</div></td>
    <td class="group">${group}</td>
    <td class="actions">
      ${viewBtn}
      <button class="btn btn-sm" onclick="event.stopPropagation(); info('${a.agent_id}')">–ò–Ω—Ñ–æ</button>
      ${unassignBtn}
    </td>
  </tr>`;
}

// –£–¥–∞–ª—è–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω-–¥—É–±–ª–∏–∫–∞—Ç—ã, –µ—Å–ª–∏ –µ—Å—Ç—å –æ–Ω–ª–∞–π–Ω —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º –ü–ö
function dedupeByHostnamePreferOnline(list){
  const map = new Map(); // host -> {hasOnline:boolean}
  for (const a of list){
    const key = (a.hostname||"").toLowerCase();
    const cur = map.get(key) || {hasOnline:false};
    if (a.online) cur.hasOnline = true;
    map.set(key, cur);
  }
  return list.filter(a=>{
    const key = (a.hostname||"").toLowerCase();
    const hasOnline = map.get(key)?.hasOnline;
    // –µ—Å–ª–∏ –ø–æ —ç—Ç–æ–º—É hostname –µ—Å—Ç—å –æ–Ω–ª–∞–π–Ω ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω –∑–∞–ø–∏—Å–∏
    return !(hasOnline && !a.online);
  });
}

function renderAgents(){
  let list = [...state.agents];
  if (state.selectedGroupId !== null) list = list.filter(a=>a.group_id===state.selectedGroupId);
  if (state.onlyOnline) list = list.filter(a=>a.online);
  if (state.search){
    const q = state.search;
    list = list.filter(a=> (a.hostname||"").toLowerCase().includes(q) || (a.agent_id||"").toLowerCase().includes(q) || (a.group_name||"").toLowerCase().includes(q));
  }
  // —Å–∫—Ä—ã–≤–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω-–¥—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –æ–Ω–ª–∞–π–Ω —Å —Ç–µ–º –∂–µ hostname
  list = dedupeByHostnamePreferOnline(list);
  list.sort((a,b)=> (b.online - a.online) || (a.hostname||"").localeCompare(b.hostname||""));
  const tb = g("agents").querySelector("tbody");
  tb.innerHTML = list.map(agentRow).join("");
  renderCounts();
  // –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç info –ø–æ —Ç–µ–∫—É—â–µ–º—É –∞–≥–µ–Ω—Ç—É ‚Äî –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å (–¥–∞–Ω–Ω—ã–µ –º–æ–≥–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è)
  if (state.currentAgentId){
    const a = state.agents.find(x=>x.agent_id===state.currentAgentId);
    if (a) g("info").innerHTML = buildInfoHTML(a);
  }
}

function pills(items){
  const arr = Array.isArray(items) ? items : [];
  if (!arr.length) return '<span class="muted">‚Äî</span>';
  return `<div class="pills">${arr.map(x=>`<span class="pill">${esc(x)}</span>`).join("")}</div>`;
}

function kv(rows){
  return `<dl class="kv">${rows.map(([k,v])=>`<dt>${esc(k)}</dt><dd>${v||'<span class="muted">‚Äî</span>'}</dd>`).join("")}</dl>`;
}

function section(title, body){
  return `<div class="section"><h4>${esc(title)}</h4>${body}</div>`;
}

function buildInfoHTML(a){
  const info = a?.info || {};
  const screen = info.screen || {};
  const hw = info.hardware || {};
  const cpu = hw.cpu || {};
  const sys = hw.system_model || {};
  const ip = N(info.ip);
  const mac = N(info.mac);
  const onlineBadge = a.online ? '<span class="chip chip-on">–û–Ω–ª–∞–π–Ω</span>' : '<span class="chip">–û—Ñ—Ñ–ª–∞–π–Ω</span>';

  const header = `
    <div class="agent-header">
      <div class="agent-title">
        <div class="agent-name">${esc(a.hostname || a.agent_id)}</div>
        <div class="agent-sub muted">${esc(a.agent_id)}</div>
      </div>
      <div class="agent-badges">
        ${onlineBadge}
        ${info.admin ? '<span class="chip chip-admin" title="–ó–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">Admin</span>' : ''}
      </div>
    </div>
  `;

  const general = kv([
    ["–ò–º—è –ü–ö", esc(a.hostname||"")],
    ["–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", esc(info.user||"")],
    ["–û–°", esc(info.os||"")],
    ["FQDN", esc(info.fqdn||"")],
    ["–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", esc(a.last_seen||"")],
  ]);

  const network = kv([
    ["–û—Å–Ω–æ–≤–Ω–æ–π IP", ip ? `<span class="mono">${esc(ip)}</span>` : ""],
    ["–í—Å–µ IP", pills(info.ips||[])],
    ["–û—Å–Ω–æ–≤–Ω–æ–π MAC", mac ? `<span class="mono">${esc(mac)}</span>` : ""],
    ["–í—Å–µ MAC", pills(info.macs||[])],
  ]);

  const screenSec = kv([
    ["–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ", (screen.width && screen.height) ? `<span class="mono">${screen.width} √ó ${screen.height}</span>` : ""],
  ]);

  const cpuLine = [
    esc(cpu.model||""),
    (cpu.cores_physical||cpu.cores_logical) ? `, —è–¥—Ä–∞: ${cpu.cores_physical||"-"}/${cpu.cores_logical||"-"}` : "",
    cpu.freq_mhz ? `, ${cpu.freq_mhz} –ú–ì—Ü` : ""
  ].join("");
  const hardware = kv([
    ["CPU", cpuLine || ""],
    ["RAM", (hw.ram_gb ? `<span class="mono">${hw.ram_gb} –ì–ë</span>` : "")],
    ["–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞", esc(hw.machine||"")],
    ["–°–∏—Å—Ç–µ–º–∞", (sys.manufacturer||sys.product_name) ? esc(`${sys.manufacturer||""} ${sys.product_name||""}`.trim()) : ""],
  ]);

  return `
    ${header}
    ${section("–û–±—â–µ–µ", general)}
    ${section("–°–µ—Ç—å", network)}
    ${section("–≠–∫—Ä–∞–Ω", screenSec)}
    ${section("–ñ–µ–ª–µ–∑–æ", hardware)}
  `;
}

async function loadGroups(){
  const data = await j("/api/groups");
  state.groups = data.groups || [];
  renderGroups();
}

async function loadAgents(){
  const data = await j("/api/agents");
  state.agents = data.agents || [];
  renderAgents();
}

async function loadAll(){ await Promise.all([loadGroups(), loadAgents()]); }

async function createGroup(){
  const name = g("gname").value.trim();
  if(!name) return false;
  await j("/api/groups", {method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify({name})});
  g("gname").value = "";
  await loadGroups();
  return false;
}

async function info(agent_id){
  const a = state.agents.find(x=>x.agent_id===agent_id);
  state.currentAgentId = agent_id;
  g("info").innerHTML = a ? buildInfoHTML(a) : '<div class="placeholder">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
  const sel = g("assign-group");
  sel.value = (a && a.group_id!=null) ? String(a.group_id) : "";
}

async function assignGroup(){
  const id = state.currentAgentId;
  if(!id) return;
  const val = g("assign-group").value;
  const gid = val ? Number(val) : null;
  await j(`/api/agents/${encodeURIComponent(id)}/assign_group`, {
    method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify({group_id: gid})
  });
  await loadAgents();
  info(id);
}

async function clearGroup(){
  const id = state.currentAgentId;
  if(!id) return;
  await unassignAgent(id);
}

async function unassignAgent(agent_id){
  await j(`/api/agents/${encodeURIComponent(agent_id)}/assign_group`, {
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({group_id: null})
  });
  await loadAgents();
  if (state.currentAgentId === agent_id){
    const sel = g("assign-group");
    if (sel) sel.value = "";
    info(agent_id);
  }
}

setInterval(loadAgents, 3000);
loadAll();
</script>